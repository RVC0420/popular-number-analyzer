<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Popular Number Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      box-sizing: border-box;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      text-align: center;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      word-wrap: break-word;
    }

    th {
      background-color: #f4f4f4;
    }

    .hidden {
      display: none;
    }

	.highlight-red {
	  background-color: #ff9999;
	}

	.highlight-orange {
	  background-color: #ffcc99;
	}

	.highlight-yellow {
	  background-color: #ffffcc;
	}

	.highlight-green {
	  background-color: #ccffcc;
	}

	.highlight-blue {
	  background-color: #cce5ff;
	}

	.highlight-purple {
	  background-color: #e5ccff;
	}

	.highlight-pink {
	  background-color: #ffcce5;
	}

	.highlight-cyan {
	  background-color: #ccffff;
	}

	.highlight-lime {
	  background-color: #eaffcc;
	}

	.highlight-lightbrown {
	  background-color: #e6ccb3;
	}

	.highlight-lightgray {
	  background-color: #f2f2f2;
	}

	.highlight-lightteal {
	  background-color: #ccffff;
	}

	.highlight-lightmagenta {
	  background-color: #ffccff;
	}

	.highlight-lightgold {
	  background-color: #fff9cc;
	}

	.highlight-lightsilver {
	  background-color: #f9f9f9;
	}

	.highlight-max-prize {
	  background-color: #ffeb3b; /* Yellow highlight */
	  font-weight: bold;
	}

    .active-button {
      background-color: #0056b3;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .active-button:hover {
      background-color: #004080;
      transform: scale(1.05);
    }

    .active-button:active {
      background-color: #003366;
      transform: scale(0.95);
    }

    /* Responsive Table Container */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 10px;
    }

    /* Media Query for Smaller Screens */
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      th, td {
        padding: 5px;
      }

      .container {
        padding: 10px;
      }

      .active-button {
        font-size: 14px;
        padding: 8px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Popular Number Analyzer</h1>
    <button id="btnLast10" class="active-button" onclick="analyzeZip('last10', 'btnLast10')">Analyze Lastest 10 Results</button>
    <button id="btnLast20" class="active-button" onclick="analyzeZip('last20', 'btnLast20')">Analyze Lastest 20 Results</button>
    <button id="btnLast30" class="active-button" onclick="analyzeZip('last30', 'btnLast30')">Analyze Lastest 30 Results</button>
    <button id="btnLast50" class="active-button" onclick="analyzeZip('last50', 'btnLast50')">Analyze Lastest 50 Results</button>
    <button id="btnLast100" class="active-button" onclick="analyzeZip('last100', 'btnLast100')">Analyze Lastest 100 Results</button>
    <button id="btnLastALL" class="active-button" onclick="analyzeZip('ALL', 'btnLastALL')">Analyze ALL Results</button>
    <h2 id="resultTitle">Results</h2>
    <div class="table-wrapper" id="top15TableWrapper">
      <table id="results">
        <thead>
          <tr>
            <th>Label</th>
            <th colspan="15">Top 15 Numbers</th>
          </tr>
        </thead>
        <tbody>
          <tr id="numberRow">
            <td><b>Number</b></td>
          </tr>
          <tr id="countRow">
            <td><b>Count</b></td>
          </tr>
        </tbody>
      </table>
    </div>
	
	<h2 id="numberRangeTitle">Number Range Analysis</h2>
    <div id="numberRangeTableWrapper" class="table-wrapper">
      <table id="numberRange">
        <thead>
          <tr>
            <th>Number Range</th>
            <th>Total Count</th>
            <th>1st Most Frequent</th>
            <th>Count</th>
            <th>2nd Most Frequent</th>
            <th>Count</th>
            <th>3rd Most Frequent</th>
            <th>Count</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 id="last20Title" class="hidden"></h2>
    <div id="last20TableWrapper" class="table-wrapper hidden">
      <table id="last20">
        <thead>
          <tr>
            <th>Date</th>
            <th>Num1</th>
            <th>Num2</th>
            <th>Num3</th>
            <th>Num4</th>
            <th>Num5</th>
            <th>Num6</th>
            <th>Prize</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 id="last10Title" class="hidden"></h2>
    <div id="last10TableWrapper" class="table-wrapper hidden">
      <table id="last10">
        <thead>
          <tr>
            <th>Date</th>
            <th>Num1</th>
            <th>Num2</th>
            <th>Num3</th>
            <th>Num4</th>
            <th>Num5</th>
            <th>Num6</th>
            <th>Prize</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  // Centralized references and state
  const state = {
    lastNumberCounts: {},
    elements: {
      buttons: document.querySelectorAll("button"),
      tables: {
        results: document.getElementById("results"),
        last20: document.getElementById("last20").getElementsByTagName("tbody")[0],
        last10: document.getElementById("last10").getElementsByTagName("tbody")[0],
        numberRange: document.getElementById("numberRange").getElementsByTagName("tbody")[0],
      },
      wrappers: {
        last10: document.getElementById("last10TableWrapper"),
        last20: document.getElementById("last20TableWrapper"),
      },
      titles: {
        last10: document.getElementById("last10Title"),
        last20: document.getElementById("last20Title"),
        numberRange: document.getElementById("numberRangeTitle"),
        result: document.getElementById("resultTitle"),
      },
    },
  };

const highlightClasses = [
  "highlight-red", "highlight-orange", "highlight-yellow",
  "highlight-green", "highlight-blue", "highlight-purple",
  "highlight-pink", "highlight-cyan", "highlight-lime",
  "highlight-lightbrown", "highlight-lightgray", "highlight-lightteal",
  "highlight-lightmagenta", "highlight-lightgold", "highlight-lightsilver"
];

  // Helper to reset UI visibility
  function resetVisibility() {
    Object.values(state.elements.wrappers).forEach(wrapper => wrapper.classList.add("hidden"));
    Object.values(state.elements.titles).forEach(title => title.classList.add("hidden"));
  }

  // Helper to reset active button styles
	function resetActiveButtons() {
	  state.elements.buttons.forEach(button => button.classList.remove("active-button"));
	}
  
  // Helper to create table rows dynamically
  function createRow(cells, isHighlighted = false) {
    const row = document.createElement("tr");
    cells.forEach((cellData, index) => {
      const cell = document.createElement("td");
      cell.textContent = cellData;

      if (isHighlighted && index > 0 && index < highlightClasses.length + 1) {
        // Skip highlighting the first column (index > 0 ensures this)
        cell.classList.add(highlightClasses[index - 1]);
      }

      row.appendChild(cell);
    });
    return row;
  }

	// Highlight numbers with specific classes for the top 15
	function highlightNumbers(numbers) {
	  const uniqueColors = new Map();
	  let colorIndex = 0;

	  numbers.slice(0, 15).forEach(([num]) => { // Restrict to top 15 numbers
		if (!uniqueColors.has(num)) {
		  uniqueColors.set(num, highlightClasses[colorIndex % highlightClasses.length]);
		  colorIndex++;
		}
	  });

	  return uniqueColors;
	}

	function processRows(rows, tableBody, numberHighlights) {
	  tableBody.innerHTML = ""; // Clear existing table rows

	  // Sort rows by date in descending order
	  const sortedRows = rows.sort((a, b) => {
		const aDate = a.split(",")[1]; // Extract the date from the row (2nd column)
		const bDate = b.split(",")[1];
		return bDate.localeCompare(aDate); // Compare as strings in descending order
	  });

	  // Determine the highest prize
	  let maxPrize = 0;
	  sortedRows.forEach(line => {
		const prize = parseInt(line.split(",").at(-1).replace(/,/g, ""), 10) || 0;
		if (prize > maxPrize) {
		  maxPrize = prize;
		}
	  });

	  // Process sorted rows and highlight the highest prize
	  sortedRows.forEach(line => {
		const columns = line.split(",");
		const date = columns[1] || "N/A";
		const numbers = columns.slice(2, 8).map(num => num || "N/A");
		const prize = parseInt(columns.at(-1)).toLocaleString() || "N/A";

		// Create and populate row
		const row = createRow([date, ...numbers, prize]);
		numbers.forEach((num, i) => {
		  const normalizedNum = parseInt(num, 10).toString();
		  if (numberHighlights.has(normalizedNum)) {
			row.cells[i + 1].classList.add(numberHighlights.get(normalizedNum));
		  }
		});

		// Highlight the cell with the highest prize
		const prizeCell = row.cells[row.cells.length - 1];
		if (parseInt(prizeCell.textContent.replace(/,/g, ""), 10) === maxPrize) {
		  prizeCell.classList.add("highlight-max-prize");
		}

		// Append row to the table body
		tableBody.appendChild(row);
	  });
	}



  // Fetch and analyze zip content
  async function analyzeZip(mode, buttonId) {
    resetActiveButtons();
    document.getElementById(buttonId).classList.add("active-button");
    resetVisibility();	

    try {
      //const response = await fetch("https://cors-anywhere.herokuapp.com/https://www.sportstoto.com.my/upload/Toto658.zip");
	  const response = await fetch("https://RVC0420.github.io/popular-number-analyzer/files/Toto658.zip");
      if (!response.ok) throw new Error("Failed to fetch the zip file.");

      const zip = await JSZip.loadAsync(await response.blob());
      const txtFile = Object.values(zip.files).find(file => file.name.endsWith(".txt"));
      if (!txtFile) throw new Error("No .txt file found in the zip.");

      const lines = (await txtFile.async("string")).split("\n").filter(line => line.trim() !== "");
      const rowsToProcess = lines.slice(-{
        last10: 10, last20: 20, last30: 30, last50: 50, last100: 100,ALL: lines.length,
      }[mode] || lines.length);

      const numberCounts = {};
      rowsToProcess.forEach(line => {
        line.split(",").slice(2, 8).forEach(num => {
          const parsedNum = parseInt(num, 10);
          if (!isNaN(parsedNum)) numberCounts[parsedNum] = (numberCounts[parsedNum] || 0) + 1;
        });
      });

      state.lastNumberCounts = numberCounts;
      const sortedNumbers = Object.entries(numberCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
      const numberHighlights = highlightNumbers(sortedNumbers);

      // Update Results Table
      const resultsBody = state.elements.tables.results.tBodies[0];
      resultsBody.innerHTML = "";
      resultsBody.appendChild(createRow(["Number", ...sortedNumbers.map(([num]) => num)], true));
      resultsBody.appendChild(createRow(["Count", ...sortedNumbers.map(([, count]) => count)], true));

      // Update Last Rows Table
      const targetTable = mode === "last10" ? state.elements.tables.last10 : state.elements.tables.last20;
      const targetWrapper = mode === "last10" ? state.elements.wrappers.last10 : state.elements.wrappers.last20;
      const targetTitle = mode === "last10" ? state.elements.titles.last10 : state.elements.titles.last20;
      processRows(rowsToProcess, targetTable, numberHighlights);
      targetWrapper.classList.remove("hidden");
      targetTitle.classList.remove("hidden");
    } catch (error) {
      console.error(error.message);
    }
	
	checkNumberRange();
  }

  // Get most frequent numbers within a range
  function getTopNumbersInRange(rangeNumbers, top = 3) {
    const frequencyMap = {};
    rangeNumbers.forEach(num => {
      frequencyMap[num] = (frequencyMap[num] || 0) + 1;
    });

    const sortedNumbers = Object.entries(frequencyMap)
      .sort((a, b) => b[1] - a[1] || rangeNumbers.lastIndexOf(b[0]) - rangeNumbers.lastIndexOf(a[0]))
      .slice(0, top);

    return sortedNumbers;
  }

  // Function to check number ranges

function checkNumberRange() {
  const ranges = [
    { label: "01 to 09", min: 1, max: 9 },
    { label: "10 to 19", min: 10, max: 19 },
    { label: "20 to 29", min: 20, max: 29 },
    { label: "30 to 39", min: 30, max: 39 },
    { label: "40 to 49", min: 40, max: 49 },
    { label: "50 to 59", min: 50, max: 59 },
  ];

  const tbody = state.elements.tables.numberRange;
  tbody.innerHTML = ""; // Clear existing table rows

  // Reuse the numberHighlights from Top 15 Numbers table
  const sortedNumbers = Object.entries(state.lastNumberCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 15);

  const numberHighlights = highlightNumbers(sortedNumbers);

  console.log("Number Highlights Map:", numberHighlights);

  ranges.forEach((range) => {
    const rangeNumbers = Object.keys(state.lastNumberCounts)
      .map((num) => parseInt(num, 10))
      .filter((num) => num >= range.min && num <= range.max);

    const totalCount = rangeNumbers.reduce(
      (sum, num) => sum + state.lastNumberCounts[num.toString()],
      0
    );

    const topNumbers = getTopNumbersInRange(
      rangeNumbers.flatMap((num) =>
        Array(state.lastNumberCounts[num.toString()]).fill(num)
      )
    );

    const row = createRow([
      range.label,
      totalCount,
      ...topNumbers.flatMap(([num, count]) => [num, count]),
    ]);

    // Apply highlight colors from Top 15 Numbers table
    [2, 4, 6].forEach((index) => {
      const cell = row.children[index];
      if (cell) {
        const num = cell.textContent.trim(); // Keep the number as a string
        console.log(`Checking cell value: ${num}`);
        if (numberHighlights.has(num)) {
          const highlightClass = numberHighlights.get(num);
          console.log(`Applying highlight ${highlightClass} to number ${num}`);
          cell.classList.add(highlightClass);
        } else {
          console.log(`No highlight found for number: ${num}`);
        }
      }
    });

    while (row.children.length < 8) {
      const emptyCell = document.createElement("td");
      emptyCell.textContent = "-";
      row.appendChild(emptyCell);
    }

    tbody.appendChild(row);
  });
}




  window.onload = () => analyzeZip("last10", "btnLast10");
  </script>
</body>
</html>
